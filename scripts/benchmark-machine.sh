#!/bin/bash
# Machine benchmarking script to determine safe agent concurrency limits
# Run this before orchestrating multiple agents

set -euo pipefail

echo "=========================================="
echo "Machine Benchmarking for Claude Code"
echo "=========================================="
echo ""

# System Information
echo "=== System Information ==="
echo "OS: $(uname -s) $(uname -r)"
echo "Architecture: $(uname -m)"
echo "Hostname: $(hostname)"
echo ""

# CPU Information
echo "=== CPU Information ==="
CPU_CORES=$(nproc)
echo "CPU Cores: $CPU_CORES"
if [ -f /proc/cpuinfo ]; then
    CPU_MODEL=$(grep "model name" /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)
    echo "CPU Model: $CPU_MODEL"
fi
echo ""

# Memory Information
echo "=== Memory Information ==="
TOTAL_RAM_MB=$(free -m | awk '/^Mem:/ {print $2}')
TOTAL_RAM_GB=$(awk "BEGIN {printf \"%.1f\", $TOTAL_RAM_MB/1024}")
AVAILABLE_RAM_MB=$(free -m | awk '/^Mem:/ {print $7}')
AVAILABLE_RAM_GB=$(awk "BEGIN {printf \"%.1f\", $AVAILABLE_RAM_MB/1024}")

echo "Total RAM: ${TOTAL_RAM_GB}GB (${TOTAL_RAM_MB}MB)"
echo "Available RAM: ${AVAILABLE_RAM_GB}GB (${AVAILABLE_RAM_MB}MB)"

free -h
echo ""

# Disk Information
echo "=== Disk Information ==="
df -h /home/user/wine-club
echo ""

# Current Load
echo "=== Current System Load ==="
uptime
echo ""

# Node.js Information (Claude Code runs on Node)
echo "=== Node.js Environment ==="
NODE_VERSION=$(node --version 2>/dev/null || echo "Not installed")
NPM_VERSION=$(npm --version 2>/dev/null || echo "Not installed")
echo "Node.js: $NODE_VERSION"
echo "NPM: $NPM_VERSION"
echo ""

# Estimate Claude Code memory usage per instance
echo "=== Claude Code Resource Estimates ==="
ESTIMATED_MEM_PER_AGENT=500  # MB per agent (conservative estimate)
echo "Estimated memory per Claude Code agent: ~${ESTIMATED_MEM_PER_AGENT}MB"
echo ""

# Calculate safe concurrency limits
echo "=== Recommended Concurrency Limits ==="

# Leave 20% RAM buffer for system
SAFE_RAM_MB=$((TOTAL_RAM_MB * 80 / 100))
MAX_AGENTS_BY_RAM=$((SAFE_RAM_MB / ESTIMATED_MEM_PER_AGENT))

# CPU-based limit (1 agent per 2 cores for responsiveness)
MAX_AGENTS_BY_CPU=$((CPU_CORES / 2))

# Take the minimum of both limits
RECOMMENDED_MAX_AGENTS=$((MAX_AGENTS_BY_RAM < MAX_AGENTS_BY_CPU ? MAX_AGENTS_BY_RAM : MAX_AGENTS_BY_CPU))

echo "Based on RAM (80% utilization): $MAX_AGENTS_BY_RAM agents"
echo "Based on CPU (1 agent per 2 cores): $MAX_AGENTS_BY_CPU agents"
echo ""
echo "✓ RECOMMENDED MAX CONCURRENT AGENTS: $RECOMMENDED_MAX_AGENTS"
echo ""

# Conservative recommendation
CONSERVATIVE_MAX=$((RECOMMENDED_MAX_AGENTS * 2 / 3))
echo "✓ CONSERVATIVE RECOMMENDATION: $CONSERVATIVE_MAX agents"
echo "  (Leaves more headroom for safety)"
echo ""

# Risk assessment
echo "=== Risk Assessment ==="
if [ "$TOTAL_RAM_MB" -lt 4096 ]; then
    echo "⚠️  LOW RAM: <4GB - Run 1-2 agents maximum"
    RISK="HIGH"
elif [ "$TOTAL_RAM_MB" -lt 8192 ]; then
    echo "⚠️  MODERATE RAM: 4-8GB - Run 2-4 agents maximum"
    RISK="MEDIUM"
elif [ "$TOTAL_RAM_MB" -lt 16384 ]; then
    echo "✓ GOOD RAM: 8-16GB - Run 4-8 agents safely"
    RISK="LOW"
else
    echo "✓ EXCELLENT RAM: >16GB - Run 8+ agents safely"
    RISK="VERY_LOW"
fi

if [ "$CPU_CORES" -lt 4 ]; then
    echo "⚠️  FEW CPU CORES: <4 - Expect slow response times"
elif [ "$CPU_CORES" -lt 8 ]; then
    echo "✓ DECENT CPU: 4-8 cores - Good for parallel work"
else
    echo "✓ EXCELLENT CPU: 8+ cores - Great for parallel work"
fi
echo ""

# Generate configuration
echo "=== Generated Configuration ==="
CONFIG_FILE="/tmp/claude-orchestration-config.env"
cat > "$CONFIG_FILE" << EOF
# Generated by benchmark-machine.sh on $(date)
# Machine capacity configuration for Claude Code orchestration

# System specs
CPU_CORES=$CPU_CORES
TOTAL_RAM_MB=$TOTAL_RAM_MB
AVAILABLE_RAM_MB=$AVAILABLE_RAM_MB

# Concurrency limits
MAX_CONCURRENT_AGENTS=$RECOMMENDED_MAX_AGENTS
CONSERVATIVE_MAX_AGENTS=$CONSERVATIVE_MAX
RISK_LEVEL=$RISK

# Resource thresholds for monitoring
MEMORY_THRESHOLD=80
CPU_THRESHOLD=90
DISK_THRESHOLD=90

# Agent launch delay (seconds between launches)
AGENT_LAUNCH_DELAY=3
EOF

echo "Configuration saved to: $CONFIG_FILE"
echo ""
cat "$CONFIG_FILE"
echo ""

# Final recommendation
echo "=========================================="
echo "FINAL RECOMMENDATION"
echo "=========================================="
echo ""
echo "For your wine-club project (8 issues to parallelize):"
echo ""

if [ "$RECOMMENDED_MAX_AGENTS" -ge 8 ]; then
    echo "✓ You CAN run all 8 agents in parallel safely"
    echo "  Strategy: Launch all issues #62-68 simultaneously after #61 completes"
    echo ""
    echo "  Suggested command:"
    echo "  ./scripts/orchestrate-parallel.sh --max-agents 8"
elif [ "$RECOMMENDED_MAX_AGENTS" -ge 4 ]; then
    echo "⚠️  Run agents in 2 batches (4 agents per batch)"
    echo "  Batch 1: Issues #62, #63, #64, #65"
    echo "  Batch 2: Issues #66, #67, #68"
    echo ""
    echo "  Suggested command:"
    echo "  ./scripts/orchestrate-parallel.sh --max-agents 4 --batched"
else
    echo "⚠️  Run agents sequentially or in small batches (2-3 at a time)"
    echo "  Your machine has limited resources for parallel execution"
    echo ""
    echo "  Suggested command:"
    echo "  ./scripts/orchestrate-parallel.sh --max-agents $RECOMMENDED_MAX_AGENTS --batched"
fi
echo ""

echo "✓ Benchmark complete! Use the config file for orchestration."
echo "  Config: $CONFIG_FILE"
echo "  Monitor: ./scripts/monitor-resources.sh"
